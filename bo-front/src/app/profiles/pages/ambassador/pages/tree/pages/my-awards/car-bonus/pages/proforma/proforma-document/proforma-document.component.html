<div class="page">
	<div class="grid">
		<!-- IZQUIERDA -->
		<div class="left">
			<div class="page-header">
				<h2 class="doc-title">Proforma {{ mode === 'edit' ? '' : 'Nueva' }}</h2>
			</div>
			<form [formGroup]="form" class="form-grid">
				<div class="field-row">
					<div class="field">
						<label class="label">Marca</label>
						<input class="control" type="text" formControlName="brandName" placeholder="Ingresa la marca"
							tabindex="1" />
						<div class="error" *ngIf="isInvalid('brandName')">{{ errorText('brandName') }}</div>
					</div>
					<div class="field">
						<label class="label">Modelo</label>
						<input class="control" type="text" formControlName="modelName" placeholder="Ingresa el modelo"
							tabindex="2" />
						<div class="error" *ngIf="isInvalid('modelName')">{{ errorText('modelName') }}</div>
					</div>
				</div>
				<div class="field-row">
					<div class="field">
						<label class="label">Color</label>
						<input class="control" type="text" formControlName="color" placeholder="Ej. AZUL"
							tabindex="3" />
						<div class="error" *ngIf="isInvalid('color')">{{ errorText('color') }}</div>
					</div>
					<div class="field">
						<label class="label">Precio</label>
						<div class="group">
							<span class="addon">$</span>
							<input class="control no-left" type="number" formControlName="price" placeholder="0.00"
								tabindex="4" />
						</div>
						<div class="error" *ngIf="isInvalid('price')">{{ errorText('price') }}</div>
					</div>
				</div>
				<div class="field-row">
					<div class="field">
						<label class="label">Concesionaria</label>
						<input class="control" type="text" formControlName="dealershipName"
							placeholder="Ingresa la concesionaria" tabindex="5" />
						<div class="error" *ngIf="isInvalid('dealershipName')">
							{{ errorText('dealershipName') }}
						</div>
					</div>
					<div class="field">
						<label class="label">Ejecutivo de ventas</label>
						<input class="control" type="text" formControlName="salesExecutiveName"
							placeholder="Ingresa el nombre del ejecutivo" tabindex="6" />
						<div class="error" *ngIf="isInvalid('salesExecutiveName')">
							{{ errorText('salesExecutiveName') }}
						</div>
					</div>
				</div>
				<div class="field-row">
					<div class="field">
						<label class="label">Celular del ejecutivo de ventas</label>

						<div class="phone-combo" [class.invalid]="isInvalid('salesExecutivePhone')">
							<div class="prefix" role="button" tabindex="-1" (click)="toggleCountryMenu($event)"
								(keydown.enter)="toggleCountryMenu($event)" (keydown.space)="toggleCountryMenu($event)">
								<img *ngIf="selectedCountry" class="flag-icon" [src]="selectedCountry.flag"
									[alt]="selectedCountry.iso + ' flag'" />
								<span class="iso">{{ selectedCountry?.iso }}</span>
								<span class="code">{{ selectedCountry?.dial }}</span>
								<i class="bi bi-chevron-down chevron" [class.open]="countryMenuOpen"
									aria-hidden="true"></i>
								<span class="sep" aria-hidden="true"></span>
							</div>
							<ul class="country-menu" *ngIf="countryMenuOpen">
								<li class="country-search-row">
									<input class="country-search" placeholder="Buscar país" (input)="onCountrySearch($event.target.value)" (click)="$event.stopPropagation()" />
								</li>
								<li class="country-option" *ngFor="let country of filteredCountries" (click)="selectCountry(country, $event)" [class.active]="country.idCountry === form.value.executiveCountryId">
									<img class="flag-icon" [src]="country.flag" [alt]="country.iso + ' flag'" />
									<span class="name">{{ country.name }}</span>
									<span class="dial">{{ country.dial }}</span>
								</li>
							</ul>
							<input class="phone-input" type="text" formControlName="salesExecutivePhone" inputmode="tel"
								autocomplete="tel" tabindex="7" />
						</div>

						<div class="error" *ngIf="isInvalid('salesExecutivePhone')">{{ errorText('salesExecutivePhone')
							}}
						</div>
					</div>
					<div class="field">
						<div class="label-row">
							<label class="label">Adjuntar proforma:</label>
							<i class="bi bi-info-circle info"></i>
						</div>
						<app-pdf-upload (urlChange)="onPdfUrlChange($event)" formControlName="quotationFile"
							[externalUrl]="quotation?.quotationUrl" tabindex="8"></app-pdf-upload>
						<div class="error" *ngIf="isInvalid('quotationFile')">{{ errorText('quotationFile') }}</div>
						<div class="error" *ngIf="form.get('quotationFile')?.errors?.['invalidType']">
							Formato no válido. Solo PDF.
						</div>
						<div class="error" *ngIf="form.get('quotationFile')?.errors?.['maxSize']">
							El archivo supera el tamaño máximo ({{ maxSizeMB }} MB).
						</div>

						<small class="hint">Formatos admitidos: PDF. Tamaño máximo: {{ maxSizeMB }}MB.</small>
					</div>
				</div>

				<!-- Cuota Inicial -->
				<div class="col-12">
					<h5 class="section-title">Cuota Inicial</h5>
				</div>

				<div class="field col-12">
					<label class="label">¿En qué evento deseas recibir tu auto?</label>
					<div class="event-combo" [class.invalid]="isInvalid('eventId')">
						<div class="event-selector" role="button" tabindex="-1" (click)="toggleEventMenu($event)"
							(keydown.enter)="toggleEventMenu($event)" (keydown.space)="toggleEventMenu($event)">
							<span class="event-name">{{ selectedEvent?.eventName || 'Selecciona uno' }}</span>
							<i class="bi bi-chevron-down chevron" [class.open]="eventMenuOpen" aria-hidden="true"></i>
						</div>
						<ul class="event-menu" *ngIf="eventMenuOpen">
							<li class="event-option" *ngFor="let e of events" (click)="selectEvent(e, $event)"
								[class.active]="e.eventId === form.value.eventId">
								<span class="name">{{ e.eventName }}</span>
							</li>
						</ul>
					</div>
					<div class="error" *ngIf="isInvalid('eventId')">{{ errorText('eventId') }}</div>
				</div>

				<div class="initial-grid col-12">
					<div class="field initial-left">
						<label class="label">¿En cuántas cuotas dividirás la inicial?</label>
						<div class="cuotas-row">
							<div class="price-inline">
								<span class="money">{{
									installmentAmount | currency : 'USD' : 'symbol' : '1.2-2'
									}}</span><span class="suffix">&nbsp;cada cuota</span>
							</div>
							<input class="control compact" type="number" min="1" max="99" maxlength="2"
								formControlName="initialInstallments" (input)="limitDigits($event)" tabindex="10" />
						</div>
					</div>

					<div class="pay-detail initial-right">
						<div class="pd-title">Detalle del pago</div>
						<div class="pd-item">
							<div>Inicial Total</div>
							<div class="val">
								{{ initialAmount | currency : 'USD' : 'symbol' : '1.2-2' }}
							</div>
						</div>
						<div class="pd-item">
							<div>Bono Empresa</div>
							<div class="val">
								{{ initialBonus | currency : 'USD' : 'symbol' : '1.2-2' }}
							</div>
						</div>
						<div class="pd-item total">
							<div>Total a pagar</div>
							<div class="val">{{ totalAmount | currency : 'USD' : 'symbol' : '1.2-2' }}</div>
						</div>
					</div>
				</div>

				<!-- Campos de inicial y bono eliminados por requerimiento -->

				<div class="actions col-12">
					<button class="btn ghost" type="button" (click)="onBack()" tabindex="11">Atrás</button>
					<button class="btn primary" type="button" (click)="onSave()" tabindex="12">Guardar</button>
				</div>
			</form>
		</div>

		<!-- DERECHA -->
		<div class="right">
			<div class="viewer">
				<object *ngIf="pdfUrl" [data]="pdfUrl" type="application/pdf" class="pdf-frame"></object>
				<div class="pdf-empty" *ngIf="!pdfUrl">
					<span>Selecciona un PDF para previsualizar</span>
				</div>
			</div>
		</div>
	</div>
</div>

<app-modal-notify *ngIf="confirmOpen" [title]="'¿Estás seguro?'" [message]="confirmMessage" [iconType]="'warning'"
	[oneButton]="false" [secondaryText]="'Revisar'" [primaryText]="'Sí, enviar'" [showBullets]="true"
	[bulletItems]="confirmBullets" [closeOnConfirm]="true" (confirmed)="confirmSend()" (canceled)="closeConfirm()"
	(closed)="closeConfirm()"></app-modal-notify>